<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: header-assets}">
    <title>Categories | Assets Manager</title>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{fragments/layout :: sidebar('categories')}"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{fragments/layout :: topbar}"></header>

            <div class="dashboard-scrollable">
                <section class="welcome-section">
                    <h1>Asset Categories</h1>
                    <p>Organize your assets into logical groups for better tracking.</p>
                </section>

                <section class="card glass">
                    <div class="card-header">
                        <h2>Manage Categories</h2>
                        <div class="header-actions">
                            <button class="filter-chip" onclick="exportCategoriesToCSV()"><i
                                    class="fas fa-file-export"></i> Export List</button>
                            <a th:href="@{/categories/add}" class="btn-action"><i class="fas fa-folder-plus"></i> Add
                                Category</a>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="assets-table">
                            <thead>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoryTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <div th:replace="~{fragments/layout :: scripts}"></div>
    <script>
        let allCategories = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/categories')
                .then(res => res.json())
                .then(categories => {
                    allCategories = categories;
                    renderCategories(allCategories);
                });
        });

        function renderCategories(categories) {
            const tbody = document.getElementById('categoryTableBody');
            tbody.innerHTML = '';

            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">No categories found matching your search.</td></tr>';
                return;
            }

            categories.forEach(cat => {
                const tr = document.createElement('tr');
                const statusBadge = cat.active
                    ? '<span class="status-badge status-in-storage">Active</span>'
                    : '<span class="status-badge status-disposed">Inactive</span>';

                const actionBtn = cat.active
                    ? `<button class="btn-icon-more text-red" title="Discontinue" onclick="deactivateCategory(${cat.id})"><i class="fas fa-ban"></i></button>`
                    : `<button class="btn-icon-more text-green" title="Reactivate" onclick="reactivateCategory(${cat.id})"><i class="fas fa-check-circle"></i></button>`;

                const imageUrl = cat.categoryImage
                    ? `data:image/jpeg;base64,${cat.categoryImage}`
                    : 'https://via.placeholder.com/40?text=No+Img';

                tr.innerHTML = `
                            <td>
                                <div class="user-pill">
                                    <img src="${imageUrl}" alt="" style="object-fit: cover;">
                                    <a href="/categories/view/${cat.id}" style="font-weight: 600; text-decoration:none; color:inherit;">${cat.name}</a>
                                </div>
                            </td>
                            <td style="color: var(--text-muted);">${cat.description || 'No description provided.'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <a href="/categories/view/${cat.id}" class="btn-icon" title="View Details"><i class="fas fa-eye"></i></a>
                                <a href="/categories/update?id=${cat.id}" class="btn-icon" title="Edit"><i class="fas fa-edit"></i></a>
                                ${actionBtn}
                            </td>
                        `;
                tbody.appendChild(tr);
            });
        }

        function deactivateCategory(id) {
            showConfirm('Are you sure you want to discontinue this category? Existing assets will remain, but it will be hidden from new registrations.', () => {
                fetch(`/api/categories/${id}`, { method: 'DELETE' })
                    .then(res => {
                        if (res.ok) {
                            showAlert('Category deactivated successfully');
                            setTimeout(() => window.location.reload(), 1000);
                        } else if (res.status === 400) {
                            return res.text().then(errorMsg => {
                                showAlert('Cannot Deactivate: ' + errorMsg, 'error');
                            });
                        } else {
                            showAlert('Failed to deactivate category', 'error');
                        }
                    })
                    .catch(err => {
                        showAlert('Error: ' + err.message, 'error');
                    });
            });
        }

        function reactivateCategory(id) {
            showConfirm('Do you want to reactivate this category? It will become available again for new asset registrations.', () => {
                fetch(`/api/categories/${id}/reactivate`, { method: 'POST' })
                    .then(res => {
                        if (res.ok) {
                            showAlert('Category reactivated successfully');
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    });
            });
        }

        function exportCategoriesToCSV() {
            const headers = ['Category Name', 'Description', 'Status'];

            fetch('/api/categories')
                .then(res => res.json())
                .then(categories => {
                    const csvData = categories.map(c => [
                        c.name || 'N/A',
                        c.description || 'No description',
                        c.active ? 'Active' : 'Inactive'
                    ]);

                    const csvContent = [
                        headers.join(','),
                        ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `asset_categories_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        }
    </script>
</body>

</html>