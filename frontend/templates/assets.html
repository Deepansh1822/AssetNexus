<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: header-assets}">
    <title>All Assets | Assets Manager</title>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{fragments/layout :: sidebar('assets')}"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{fragments/layout :: topbar}"></header>

            <div class="dashboard-scrollable">
                <section class="welcome-section">
                    <h1>Asset Inventory</h1>
                    <p>Manage and track all enterprise assets from a single interface.</p>
                </section>

                <section class="card glass">
                    <div class="card-header">
                        <h2>All Assets</h2>
                        <div class="header-actions">
                            <button class="filter-chip" onclick="exportAssetsToCSV()"><i class="fas fa-file-export"></i>
                                Export List</button>
                            <a th:href="@{/assets/add}" class="btn-action" sec:authorize="hasRole('ADMIN')"
                                style="margin-right: 1rem;">
                                <i class="fas fa-plus"></i> Add Asset
                            </a>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="assets-table">
                            <thead>
                                <tr>
                                    <th>Asset Tag</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Assignee</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>


        </main>
    </div>
    <div th:replace="~{fragments/layout :: scripts}"></div>
    <script>
        let allAssets = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch Current User first
                const userRes = await fetch('/api/auth/me');
                if (!userRes.ok) throw new Error('Not authenticated');
                const currentUser = await userRes.json();
                const isAdmin = currentUser.userRole === 'ADMIN';

                // Fetch Assets
                const assetsRes = await fetch('/api/assets');
                allAssets = await assetsRes.json();

                // Match assets with current view
                renderAssets(allAssets, isAdmin, currentUser);
            } catch (err) {
                console.error('Error:', err);
            }
        });

        function renderAssets(assets, isAdmin, currentUser) {
            let filtered = assets;
            if (!isAdmin) {
                filtered = assets.filter(a => a.employee && a.employee.id === currentUser.id);
            }

            if (!isAdmin) {
                document.querySelector('.welcome-section h1').textContent = 'Assigned Assets';
                document.querySelector('.welcome-section p').textContent = 'View and manage assets currently assigned to you.';
                document.querySelector('.card-header h2').textContent = 'Assets';
            }

            const tbody = document.getElementById('assetsTableBody');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem;">No assets found matching your criteria.</td></tr>`;
                return;
            }

            filtered.forEach(asset => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                        <td><span class="a-tag">${asset.assetTag || 'N/A'}</span></td>
                        <td><a href="/assets/view/${asset.id}" class="a-title" style="text-decoration:none;">${asset.name}</a></td>
                        <td>${asset.category ? asset.category.name : 'Uncategorized'}</td>
                        <td><span class="status-badge ${asset.status ? asset.status.toLowerCase().replace('_', '-') : 'available'}">${asset.status || 'AVAILABLE'}</span></td>
                        <td>
                            ${asset.employee ? `
                                <div class="user-pill">
                                    <img src="${(asset.employee && asset.employee.hasImage) ? `/api/employees/${asset.employee.id}/image` : `https://ui-avatars.com/api/?name=${asset.employee.name}&size=24`}" alt="">
                                    <span>${asset.employee.name}</span>
                                </div>
                            ` : '-'}
                        </td>
                        <td>
                            <a href="/assets/view/${asset.id}" class="btn-icon" title="View Details"><i class="fas fa-eye"></i></a>
                            <button class="btn-icon" title="View Barcode" onclick="showBarcode(${asset.id})"><i class="fas fa-barcode"></i></button>
                            ${isAdmin ? `
                                <a href="/assets/assign" class="btn-icon" title="Assign/Re-Assign"><i class="fas fa-exchange-alt"></i></a>
                                <a href="/assets/update?id=${asset.id}" class="btn-icon-more" title="Edit"><i class="fas fa-edit"></i></a>
                                <button class="btn-icon-more text-red" title="Delete" onclick="deleteAsset(${asset.id})"><i class="fas fa-trash-alt"></i></button>
                            ` : `
                                <a href="/maintenance/employee" class="btn-icon" title="Report Issue"><i class="fas fa-wrench"></i></a>
                            `}
                        </td>
                    `;
                tbody.appendChild(tr);
            });
        }

        function showBarcode(id) {
            const asset = allAssets.find(a => a.id === id);
            if (asset) showAssetBarcode(asset);
        }

        function deleteAsset(id) {
            showConfirm('Are you sure you want to delete this asset? This action cannot be undone.', () => {
                fetch(`/api/assets/${id}`, { method: 'DELETE' })
                    .then(res => {
                        if (res.ok) {
                            showAlert('Asset deleted successfully');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showAlert('Failed to delete asset', 'error');
                        }
                    });
            });
        }

        function exportAssetsToCSV() {
            const headers = ['Asset Tag', 'Name', 'Category', 'Status', 'Assignee', 'Serial Number', 'Location', 'Purchase Date', 'Purchase Cost'];

            fetch('/api/assets')
                .then(res => res.json())
                .then(assets => {
                    const csvData = assets.map(a => [
                        a.assetTag || 'N/A',
                        a.name || 'N/A',
                        a.category ? a.category.name : 'Uncategorized',
                        a.status || 'AVAILABLE',
                        a.employee ? a.employee.name : 'Unassigned',
                        a.serialNumber || 'N/A',
                        a.location || 'N/A',
                        a.purchaseDate || 'N/A',
                        a.purchaseCost || '0'
                    ]);

                    const csvContent = [
                        headers.join(','),
                        ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `asset_inventory_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        }
    </script>
</body>

</html>