<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head th:replace="~{fragments/layout :: header-assets}">
    <title>Maintenance Details | AssetNexus</title>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{fragments/layout :: sidebar('maintenance')}"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{fragments/layout :: topbar}"></header>

            <div class="dashboard-scrollable">
                <div class="header-with-actions"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <section class="welcome-section" style="margin-bottom: 0;">
                        <p
                            style="text-transform: uppercase; font-size: 0.75rem; font-weight: 700; color: var(--primary); letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                            Maintenance & Service Log</p>
                        <h1 style="margin: 0;"><i class="fas fa-tools"
                                style="margin-right:0.6rem; color:var(--primary); font-size:0.9em; opacity:0.9;"></i><span
                                id="maintenanceMainTitle">Loading...</span></h1>
                        <div id="requestIdDisplay"
                            style="display: inline-block; margin-top: 0.75rem; padding: 0.4rem 0.85rem; background: rgba(99, 102, 241, 0.1); color: var(--primary); border-radius: 50px; font-size: 0.8rem; font-weight: 700; border: 1px solid rgba(99, 102, 241, 0.2);">
                            <i class="fas fa-fingerprint" style="margin-right: 0.4rem;"></i> Reference ID: #...
                        </div>
                    </section>
                    <div class="actions-group">
                        <button class="btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                        <button sec:authorize="hasRole('ADMIN')" class="btn-submit" onclick="openUpdateModal()"
                            style="margin-left: 0.75rem;">
                            <i class="fas fa-edit"></i> Update Status
                        </button>
                    </div>
                </div>

                <div class="detail-top-grid">
                    <!-- Main Content Column -->
                    <div class="detail-main-col">
                        <!-- Issue & Core Details -->
                        <div class="card glass" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="kpi-icon amber" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                            class="fas fa-circle-exclamation"></i></div>
                                    <h2 style="margin:0;">Reported Issue & Status</h2>
                                </div>
                                <span id="statusBadge" class="status-badge">PENDING</span>
                            </div>
                            <div class="card-body">
                                <div class="issue-description-box"
                                    style="background: #f1f5f9; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                    <h4
                                        style="margin-bottom: 0.75rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                        User Reported Description</h4>
                                    <p id="issueDescription"
                                        style="font-size: 1.1rem; line-height: 1.6; color: var(--text-main); font-weight: 500;">
                                        -</p>
                                </div>

                                <div class="info-grid-3">
                                    <div class="info-item">
                                        <label>Priority Level</label>
                                        <span id="priority" class="priority-badge">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Reported On</label>
                                        <span id="requestedDate" style="font-weight: 600;">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Maintenance Type</label>
                                        <span id="maintenanceType" class="type-badge">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Details & Admin Notes -->
                        <div class="card glass" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="kpi-icon blue" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                            class="fas fa-tools"></i></div>
                                    <h2 style="margin:0;">Resolution & Technical Notes</h2>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="info-grid-2" style="margin-bottom: 1.5rem;">
                                    <div class="info-item">
                                        <label>Assigned Technician / Vendor</label>
                                        <div class="technician-pill"
                                            style="display: flex; align-items: center; gap: 0.75rem; background: var(--bg-main); padding: 0.6rem 1rem; border-radius: 10px; border: 1px solid var(--border);">
                                            <i class="fas fa-user-gear" style="color: var(--primary);"></i>
                                            <span id="assignedTechnician" style="font-weight: 600;">Not Assigned</span>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <label>Resolved / Completed On</label>
                                        <span id="completedDate" style="font-weight: 600; color: var(--green);">Pending
                                            Resolution</span>
                                    </div>
                                </div>

                                <div class="admin-notes-section">
                                    <label
                                        style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Admin/Technical
                                        Resolution Notes</label>
                                    <div id="adminNotes"
                                        style="background: #fff; border: 1px dashed var(--border); padding: 1.25rem; border-radius: 10px; min-height: 100px; color: var(--text-muted); font-style: italic;">
                                        No internal notes have been added yet.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cost Summary -->
                        <div class="card glass" id="costCard">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="kpi-icon green" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                            class="fas fa-receipt"></i></div>
                                    <h2 style="margin:0;">Financial Summary</h2>
                                </div>
                            </div>
                            <div class="card-body"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <p style="color: var(--text-muted); font-size: 0.9rem;">Estimated / Actual Cost of
                                        Maintenance</p>
                                    <h2 id="maintenanceCost"
                                        style="font-size: 2.25rem; font-weight: 800; color: var(--text-main); margin-top: 0.5rem;">
                                        ₹ 0.00</h2>
                                </div>
                                <div
                                    style="background: rgba(16, 185, 129, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--green); font-size: 2rem;">
                                    <i class="fas fa-money-bill-trend-up"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Content Column -->
                    <div class="detail-side-col">
                        <!-- Asset Preview Card -->
                        <div class="card glass" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="kpi-icon indigo" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                            class="fas fa-box"></i></div>
                                    <h2 style="margin:0;">Associated Asset</h2>
                                </div>
                                <a id="viewAssetLink" href="#" class="btn-icon" title="View Full Asset"><i
                                        class="fas fa-external-link-alt"></i></a>
                            </div>
                            <div class="card-body" style="text-align: center;">
                                <div id="assetImageContainer" style="margin-bottom: 1.5rem;">
                                    <img id="assetImage" src="" alt="Asset"
                                        style="width: 100%; max-width: 180px; height: 120px; object-fit: contain; border-radius: 12px; background: #fff; padding: 10px; border: 1px solid var(--border);">
                                </div>
                                <h3 id="assetName" style="margin-bottom: 0.25rem;">-</h3>
                                <p id="assetTag" class="a-tag" style="margin-bottom: 1.5rem;">#TAG-000</p>

                                <div class="mini-info-list"
                                    style="text-align: left; background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 12px;">
                                    <div class="mini-item" style="margin-bottom: 0.75rem;">
                                        <label
                                            style="display: block; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700;">Category</label>
                                        <span id="assetCategory" style="font-weight: 600;">-</span>
                                    </div>
                                    <div class="mini-item">
                                        <label
                                            style="display: block; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700;">Current
                                            Status</label>
                                        <span id="assetStatus">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Requester Info Card -->
                        <div class="card glass">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="kpi-icon indigo" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                            class="fas fa-user-circle"></i></div>
                                    <h2 style="margin:0;">Reported By</h2>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="requester-box" style="display: flex; align-items: center; gap: 1rem;">
                                    <img id="requesterImg" src="" alt=""
                                        style="width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--primary-light);">
                                    <div>
                                        <h4 id="requesterName" style="margin: 0; font-size: 1rem;">-</h4>
                                        <p id="requesterRole"
                                            style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">-</p>
                                    </div>
                                </div>
                                <div id="sourceBadge" class="source-badge"
                                    style="margin-top: 1rem; display: inline-block;">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                <footer th:replace="~{fragments/layout :: main-footer}"></footer>
            </div>
        </main>
    </div>

    <!-- Status Update Modal (Reusing existing modal logic from requests page) -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Request Status</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalRequestId">
                <div class="form-group">
                    <label>Status</label>
                    <select id="modalStatus" class="form-control">
                        <option value="PENDING">Pending</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Assigned Technician / Vendor</label>
                    <input type="text" id="modalTechnician" class="form-control"
                        placeholder="e.g. John Doe, Dell Service Unit...">
                </div>
                <div class="form-group">
                    <label>Maintenance Cost (₹)</label>
                    <input type="number" id="modalCost" class="form-control" step="0.01" value="0.00">
                </div>
                <div class="form-group">
                    <label>Resolution / Admin Notes</label>
                    <textarea id="modalNotes" class="form-control" rows="4"
                        placeholder="Add details about the repair or reason for update..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="updateStatus()">Apply Changes</button>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: scripts}"></div>
    <script>
        let maintenanceRequest = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParts = window.location.pathname.split('/');
            const id = urlParts[urlParts.length - 1];

            if (id) {
                loadMaintenanceDetails(id);
            }
        });

        function loadMaintenanceDetails(id) {
            fetch(`/api/maintenance/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error('Request not found');
                    return res.json();
                })
                .then(data => {
                    maintenanceRequest = data;
                    populateDetails(data);
                })
                .catch(err => {
                    console.error(err);
                    showAlert('Error loading maintenance details', 'error');
                });
        }

        function populateDetails(data) {
            // Header
            document.getElementById('maintenanceMainTitle').textContent = data.asset.name;
            document.getElementById('requestIdDisplay').innerHTML = `<i class="fas fa-fingerprint" style="margin-right: 0.4rem;"></i> Reference ID: #${data.id}`;

            // Status & Issue
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = data.status.replace('_', ' ');
            statusBadge.className = `status-badge ${data.status.toLowerCase().replace('_', '-')}`;

            document.getElementById('issueDescription').textContent = data.issueDescription;

            const priorityBadge = document.getElementById('priority');
            priorityBadge.textContent = data.priority;
            priorityBadge.className = `priority-badge ${data.priority.toLowerCase()}`;

            document.getElementById('requestedDate').textContent = new Date(data.requestedDate).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            const typeBadge = document.getElementById('maintenanceType');
            typeBadge.textContent = data.maintenanceType;
            typeBadge.className = `type-badge ${data.maintenanceType.toLowerCase()}`;

            // Technical
            document.getElementById('assignedTechnician').textContent = data.assignedTechnician || 'Not Assigned';
            if (data.completedDate) {
                document.getElementById('completedDate').textContent = new Date(data.completedDate).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            } else {
                document.getElementById('completedDate').textContent = 'Pending Resolution';
            }

            if (data.adminNotes) {
                document.getElementById('adminNotes').textContent = data.adminNotes;
                document.getElementById('adminNotes').style.fontStyle = 'normal';
                document.getElementById('adminNotes').style.color = 'var(--text-main)';
            }

            // Cost
            document.getElementById('maintenanceCost').textContent = `₹ ${(data.cost || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            // Asset
            document.getElementById('assetName').textContent = data.asset.name;
            document.getElementById('assetTag').textContent = `#${data.asset.assetTag || 'N/A'}`;
            document.getElementById('assetCategory').textContent = data.asset.category ? data.asset.category.name : 'N/A';

            const aStatus = document.getElementById('assetStatus');
            aStatus.innerHTML = `<span class="status-badge ${data.asset.status.toLowerCase().replace('_', '-')}">${data.asset.status}</span>`;

            document.getElementById('viewAssetLink').href = `/assets/view/${data.asset.id}`;

            if (data.asset.hasImage) {
                document.getElementById('assetImage').src = `/api/assets/${data.asset.id}/image`;
            } else {
                document.getElementById('assetImage').src = 'https://cdn-icons-png.flaticon.com/512/1250/1250615.png';
            }

            // Requester
            const requester = data.requestedBy;
            document.getElementById('requesterName').textContent = requester.name;
            document.getElementById('requesterRole').textContent = requester.role || 'Staff Member';

            const reqImg = requester.hasImage ? `/api/employees/${requester.id}/image` : `https://ui-avatars.com/api/?name=${requester.name}&background=6366f1&color=fff&size=50`;
            document.getElementById('requesterImg').src = reqImg;

            const sourceBadge = document.getElementById('sourceBadge');
            sourceBadge.textContent = data.requestedByAdmin ? 'Admin Raised' : 'Staff Request';
            sourceBadge.className = `source-badge ${data.requestedByAdmin ? 'admin' : 'employee'}`;
        }

        function openUpdateModal() {
            if (!maintenanceRequest) return;

            document.getElementById('modalRequestId').value = maintenanceRequest.id;
            document.getElementById('modalStatus').value = maintenanceRequest.status;
            document.getElementById('modalNotes').value = maintenanceRequest.adminNotes || '';
            document.getElementById('modalTechnician').value = maintenanceRequest.assignedTechnician || '';
            document.getElementById('modalCost').value = maintenanceRequest.cost || '0.00';
            document.getElementById('statusModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('statusModal').style.display = 'none';
        }

        function updateStatus() {
            const id = document.getElementById('modalRequestId').value;
            const status = document.getElementById('modalStatus').value;
            const adminNotes = document.getElementById('modalNotes').value;
            const assignedTechnician = document.getElementById('modalTechnician').value;
            const cost = document.getElementById('modalCost').value;
            const btn = event.target;

            setBtnLoading(btn, true, 'Updating...');

            fetch(`/api/maintenance/${id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status,
                    adminNotes,
                    assignedTechnician,
                    cost: parseFloat(cost)
                })
            })
                .then(res => {
                    if (!res.ok) throw new Error('Update failed');
                    return res.json();
                })
                .then(data => {
                    closeModal();
                    showAlert('Maintenance status updated successfully!');
                    loadMaintenanceDetails(id); // Reload to show changes
                })
                .catch(err => {
                    console.error(err);
                    showAlert('Failed to update status', 'error');
                })
                .finally(() => {
                    setBtnLoading(btn, false);
                });
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('statusModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>

    <style>
        .detail-top-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .info-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .info-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 1024px) {
            .detail-top-grid {
                grid-template-columns: 1fr;
            }

            .info-grid-3 {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</body>

</html>