<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: header-assets}">
    <title>Employee Profile | AssetNexus</title>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{fragments/layout :: sidebar('employees')}"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{fragments/layout :: topbar}"></header>

            <div class="dashboard-scrollable">
                <section class="welcome-section" style="display: flex; gap: 2rem; align-items: flex-end;">
                    <div class="profile-header-img">
                        <img id="empLargeImg" src="https://ui-avatars.com/api/?name=User&size=120" alt="Employee Photo">
                    </div>
                    <div style="flex: 1;">
                        <p
                            style="text-transform: uppercase; font-size: 0.75rem; font-weight: 700; color: var(--primary); letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                            Employee Profile</p>
                        <h1 style="margin: 0;"><i class="fas fa-user-tie"
                                style="margin-right: 0.5rem; color: var(--primary);"></i><span
                                id="empName">Loading...</span></h1>
                        <p style="margin: 0.25rem 0 0.75rem 0; color: var(--text-muted);"><i class="fas fa-briefcase"
                                style="margin-right:0.4rem; font-size:0.85rem; opacity:0.7;"></i><span
                                id="empRole">---</span></p>
                        <div class="emp-meta-badges">
                            <span id="empEmailBadge" class="email-pill"><i class="fas fa-envelope"></i> ---</span>
                            <span id="empPhoneBadge" class="phone-pill"><i class="fas fa-phone"></i> ---</span>
                            <span id="empDeptBadge" class="dept-pill"><i class="fas fa-building"></i> ---</span>
                            <span id="empAccessRole" class="role-pill ---"><i class="fas fa-shield-alt"></i> ---</span>
                            <span id="empIdBadge" class="id-pill"><i class="fas fa-id-badge"></i> ---</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                        <button sec:authorize="hasRole('ADMIN')" class="btn-primary" onclick="editEmployee()"
                            style="margin-left: 0.5rem;">
                            <i class="fas fa-edit"></i> Update
                        </button>
                    </div>
                </section>

                <div class="detail-grid">
                    <!-- Statistics Cards -->
                    <div class="stats-mini-grid">
                        <div class="kpi-card glass">
                            <div class="kpi-icon blue"><i class="fas fa-box"></i></div>
                            <div class="kpi-data">
                                <h3>Assigned Assets</h3>
                                <p class="number" id="assignedCount">0</p>
                            </div>
                        </div>
                        <div class="kpi-card glass">
                            <div class="kpi-icon indigo"><i class="fas fa-tools"></i></div>
                            <div class="kpi-data">
                                <h3>Service Requests</h3>
                                <p class="number" id="requestCount">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Currently Assigned Assets -->
                    <section class="card glass">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="kpi-icon blue" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                        class="fas fa-check-double"></i></div>
                                <h2 style="margin:0;">Currently Assigned Assets</h2>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="assets-table">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Tag</th>
                                        <th>Category</th>
                                        <th>Assigned On</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="assignedAssetsBody">
                                    <tr>
                                        <td colspan="5" style="text-align:center;">No assets assigned</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Assignment History -->
                    <section class="card glass">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="kpi-icon indigo" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                        class="fas fa-history"></i></div>
                                <h2 style="margin:0;">Asset Assignment History</h2>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="assets-table">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Tag</th>
                                        <th>Assigned On</th>
                                        <th>Returned On</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="empHistoryBody">
                                    <tr>
                                        <td colspan="5" style="text-align:center;">No historical records found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Maintenance History -->
                    <section class="card glass">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="kpi-icon amber" style="width: 40px; height: 40px; font-size: 1rem;"><i
                                        class="fas fa-tools"></i></div>
                                <h2 style="margin:0;">Maintenance Requests Raised</h2>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="assets-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Asset</th>
                                        <th>Issue</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="empRequestsBody">
                                    <tr>
                                        <td colspan="5" style="text-align:center;">No requests found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            <footer th:replace="~{fragments/layout :: main-footer}"></footer>
            </div>
        </main>
    </div>

    <style>
        .profile-header-img img {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            object-fit: cover;
            border: 4px solid var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .emp-meta-badges {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
            flex-wrap: wrap;
        }

        .email-pill,
        .phone-pill,
        .dept-pill,
        .role-pill,
        .id-pill {
            padding: 0.5rem 1.25rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }

        .email-pill {
            background: rgba(56, 189, 248, 0.08);
            color: #38bdf8;
            border-color: rgba(56, 189, 248, 0.2);
        }

        .phone-pill {
            background: rgba(232, 121, 249, 0.08);
            color: #e879f9;
            border-color: rgba(232, 121, 249, 0.2);
        }

        .dept-pill {
            background: rgba(99, 102, 241, 0.08);
            color: var(--primary);
            border-color: rgba(99, 102, 241, 0.2);
            font-weight: 700;
        }

        .id-pill {
            background: rgba(148, 163, 184, 0.08);
            color: #94a3b8;
            border-color: rgba(148, 163, 184, 0.2);
        }

        .role-pill {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .role-pill.admin {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .role-pill.employee {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .detail-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stats-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
    </style>

    <div th:replace="~{fragments/layout :: scripts}"></div>
    <script>
        const empId = window.location.pathname.split('/').pop();

        document.addEventListener('DOMContentLoaded', () => {
            if (!empId) {
                showAlert('Invalid Employee ID', 'error');
                return;
            }
            loadEmployeeProfile();
            loadEmployeeAssets();
            loadEmployeeHistory();
            loadEmployeeRequests();
        });

        function loadEmployeeProfile() {
            fetch(`/api/employees/${empId}`)
                .then(res => res.json())
                .then(emp => {
                    document.getElementById('empName').textContent = emp.name;
                    document.getElementById('empRole').textContent = emp.role || 'Employee';
                    document.getElementById('empEmailBadge').innerHTML = `<i class="fas fa-envelope"></i> ${emp.email}`;
                    document.getElementById('empPhoneBadge').innerHTML = `<i class="fas fa-phone"></i> ${emp.phone || 'N/A'}`;
                    document.getElementById('empDeptBadge').innerHTML = `<i class="fas fa-building"></i> ${emp.department || 'General'}`;

                    const roleBadge = document.getElementById('empAccessRole');
                    roleBadge.innerHTML = `<i class="fas fa-shield-alt"></i> ${emp.userRole || 'EMPLOYEE'}`;
                    roleBadge.className = `role-pill ${emp.userRole === 'ADMIN' ? 'admin' : 'employee'}`;

                    document.getElementById('empIdBadge').innerHTML = `<i class="fas fa-id-badge"></i> EMP-${emp.id}`;

                    const img = emp.hasImage ? `/api/employees/${emp.id}/image` : `https://ui-avatars.com/api/?name=${emp.name}&size=120&background=6366f1&color=fff`;
                    document.getElementById('empLargeImg').src = img;
                });
        }

        function loadEmployeeHistory() {
            fetch(`/api/reports/employee/${empId}`)
                .then(res => res.json())
                .then(history => {
                    const tbody = document.getElementById('empHistoryBody');
                    if (history && history.length > 0) {
                        tbody.innerHTML = history.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate)).map(record => `
                            <tr>
                                <td><a href="/assets/view/${record.asset.id}" class="a-title" style="text-decoration:none;">${record.asset.name}</a></td>
                                <td><span class="a-tag">#${record.asset.assetTag}</span></td>
                                <td>${record.assignedDate ? new Date(record.assignedDate).toLocaleDateString() : '---'}</td>
                                <td>${record.returnedDate ? new Date(record.returnedDate).toLocaleDateString() : '<span style="color:var(--primary); font-style:italic;">Active</span>'}</td>
                                <td>
                                    <span class="status-badge ${record.returnedDate ? 'disposed' : 'in-use'}">
                                        ${record.returnedDate ? 'RETURNED' : 'CURRENTLY HELD'}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                    }
                })
                .catch(err => console.error('Error loading history:', err));
        }

        function loadEmployeeAssets() {
            fetch(`/api/assets`)
                .then(res => res.json())
                .then(assets => {
                    const assigned = assets.filter(a => a.employee && a.employee.id == empId);
                    document.getElementById('assignedCount').textContent = assigned.length;

                    const tbody = document.getElementById('assignedAssetsBody');
                    if (assigned.length > 0) {
                        tbody.innerHTML = assigned.map(a => `
                            <tr>
                                <td><a href="/assets/view/${a.id}" class="a-title" style="text-decoration:none;">${a.name}</a></td>
                                <td><span class="a-tag">#${a.assetTag}</span></td>
                                <td>${a.category ? a.category.name : '---'}</td>
                                <td>${a.assignmentDate ? new Date(a.assignmentDate).toLocaleDateString() : '---'}</td>
                                <td><span class="status-badge ${a.status.toLowerCase().replace('_', '-')}">${a.status}</span></td>
                            </tr>
                        `).join('');
                    }
                });
        }

        function loadEmployeeRequests() {
            fetch(`/api/maintenance/employee/${empId}`)
                .then(res => res.json())
                .then(requests => {
                    document.getElementById('requestCount').textContent = requests.length;

                    const tbody = document.getElementById('empRequestsBody');
                    if (requests.length > 0) {
                        tbody.innerHTML = requests.map(r => `
                            <tr>
                                <td>#${r.id}</td>
                                <td>${r.asset ? r.asset.name : 'N/A'}</td>
                                <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.issueDescription}</td>
                                <td><span class="priority-badge ${r.priority.toLowerCase()}">${r.priority}</span></td>
                                <td><span class="status-badge ${r.status.toLowerCase().replace('_', '-')}">${r.status.replace('_', ' ')}</span></td>
                            </tr>
                        `).join('');
                    }
                });
        }

        function editEmployee() {
            window.location.href = `/employees/update?id=${empId}`;
        }
    </script>
</body>

</html>
